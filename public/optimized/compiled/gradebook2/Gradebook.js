(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=[].slice,n=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define(["slickgrid.long_text_editor","compiled/views/KeyboardNavDialog","jst/KeyboardNavDialog","vendor/slickgrid","compiled/gradebook2/TotalColumnHeaderView","compiled/util/round","compiled/views/InputFilterView","i18n!gradebook2","compiled/gradebook2/GRADEBOOK_TRANSLATIONS","jquery","underscore","Backbone","timezone","compiled/grade_calculator","compiled/userSettings","vendor/spin","compiled/SubmissionDetailsDialog","compiled/gradebook2/AssignmentGroupWeightsDialog","compiled/gradebook2/GradeDisplayWarningDialog","compiled/gradebook2/SubmissionCell","compiled/gradebook2/GradebookHeaderMenu","compiled/util/NumberCompare","str/htmlEscape","compiled/gradebook2/UploadDialog","compiled/gradebook2/PostGradesDialog","compiled/gradebook2/PostGradesModel","jst/gradebook2/column_header","jst/gradebook2/group_total_cell","jst/gradebook2/row_student_name","compiled/views/gradebook/SectionMenuView","compiled/gradebook2/GradebookKeyboardNav","jst/_avatar","jquery.ajaxJSON","jquery.instructure_date_and_time","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","jqueryui/mouse","jqueryui/position","jqueryui/sortable","compiled/jquery.kylemenu","compiled/jquery/fixDialogButtons"],function(s,i,o,r,a,u,l,d,h,c,m,g,p,_,f,C,b,y,w,v,S,k,T,G,O,x,F,A,N,R,D){var P;return P=function(){function g(n){var s,i,o,r=this;this.options=n,this.setAssignmentWarnings=t(this.setAssignmentWarnings,this),this.gradeSort=t(this.gradeSort,this),this.localeSort=t(this.localeSort,this),this.onCellChange=t(this.onCellChange,this),this.onBeforeEditCell=t(this.onBeforeEditCell,this),this.initGrid=t(this.initGrid,this),this.onUserFilterInput=t(this.onUserFilterInput,this),this.togglePointsOrPercentTotals=t(this.togglePointsOrPercentTotals,this),this.switch_total_display_and_mark_user_as_warned=t(this.switch_total_display_and_mark_user_as_warned,this),this.switch_total_display=t(this.switch_total_display,this),this.displayPointTotals=t(this.displayPointTotals,this),this.weightedGroups=t(this.weightedGroups,this),this.studentNamesToggle=t(this.studentNamesToggle,this),this.initHeader=t(this.initHeader,this),this.displayPostGradesButton=t(this.displayPostGradesButton,this),this.updateCurrentSection=t(this.updateCurrentSection,this),this.onGridBlur=t(this.onGridBlur,this),this.hoverMinimizedCell=t(this.hoverMinimizedCell,this),this.unminimizeColumn=t(this.unminimizeColumn,this),this.minimizeColumn=t(this.minimizeColumn,this),this.fixColumnReordering=t(this.fixColumnReordering,this),this.unhighlightColumns=t(this.unhighlightColumns,this),this.highlightColumn=t(this.highlightColumn,this),this.calculateStudentGrade=t(this.calculateStudentGrade,this),this.htmlContentFormatter=t(this.htmlContentFormatter,this),this.groupTotalFormatter=t(this.groupTotalFormatter,this),this.uneditableCellFormatter=t(this.uneditableCellFormatter,this),this.staticCellFormatter=t(this.staticCellFormatter,this),this.cellFormatter=t(this.cellFormatter,this),this.updateSubmissionsFromExternal=t(this.updateSubmissionsFromExternal,this),this.updateSubmission=t(this.updateSubmission,this),this.withAllStudents=t(this.withAllStudents,this),this.student=t(this.student,this),this.gotSubmissionsChunk=t(this.gotSubmissionsChunk,this),this.getSubmissionsChunks=t(this.getSubmissionsChunks,this),this.buildRows=t(this.buildRows,this),this.assignmentGroupHtml=t(this.assignmentGroupHtml,this),this.moveTotalColumn=t(this.moveTotalColumn,this),this.renderTotalHeader=t(this.renderTotalHeader,this),this.handleAssignmentGroupWeightChange=t(this.handleAssignmentGroupWeightChange,this),this.handleAssignmentMutingChange=t(this.handleAssignmentMutingChange,this),this.rowFilter=t(this.rowFilter,this),this.wrapColumnSortFn=t(this.wrapColumnSortFn,this),this.makeCompareAssignmentCustomOrderFn=t(this.makeCompareAssignmentCustomOrderFn,this),this.compareAssignmentDueDates=t(this.compareAssignmentDueDates,this),this.compareAssignmentPositions=t(this.compareAssignmentPositions,this),this.makeColumnSortFn=t(this.makeColumnSortFn,this),this.arrangeColumnsBy=t(this.arrangeColumnsBy,this),this.setArrangementTogglersVisibility=t(this.setArrangementTogglersVisibility,this),this.storeCustomColumnOrder=t(this.storeCustomColumnOrder,this),this.onColumnsReordered=t(this.onColumnsReordered,this),this.setStoredSortOrder=t(this.setStoredSortOrder,this),this.getStoredSortOrder=t(this.getStoredSortOrder,this),this.studentsThatCanSeeAssignment=t(this.studentsThatCanSeeAssignment,this),this.gotChunkOfStudents=t(this.gotChunkOfStudents,this),this.gotSections=t(this.gotSections,this),this.gotAssignmentGroups=t(this.gotAssignmentGroups,this),this.doSlickgridStuff=t(this.doSlickgridStuff,this),this.chunk_start=0,this.students={},this.studentViewStudents={},this.rows=[],this.assignmentsToHide=f.contextGet("hidden_columns")||[],this.sectionToShow=f.contextGet("grading_show_only_section"),this.sectionToShow=this.sectionToShow&&String(this.sectionToShow),this.show_attendance=f.contextGet("show_attendance"),this.include_ungraded_assignments=f.contextGet("include_ungraded_assignments"),this.userFilterRemovedRows=[],this.show_concluded_enrollments=f.contextGet("show_concluded_enrollments"),this.options.course_is_concluded&&(this.show_concluded_enrollments=!0),this.totalColumnInFront=f.contextGet("total_column_in_front"),this.numberOfFrozenCols=this.totalColumnInFront?3:2,c.subscribe("assignment_group_weights_changed",this.handleAssignmentGroupWeightChange),c.subscribe("assignment_muting_toggled",this.handleAssignmentMutingChange),c.subscribe("submissions_updated",this.updateSubmissionsFromExternal),c.subscribe("currentSection/change",this.updateCurrentSection),s=this.show_concluded_enrollments?"students_url_with_concluded_enrollments":"students_url",i=c.Deferred().done(function(){return r.gotAllStudents()}),this.alignCoursePreferencesWithLocalStorage(),c.when(c.ajaxJSON(this.options[s],"GET"),c.ajaxJSON(this.options.assignment_groups_url,"GET",{},this.gotAssignmentGroups),c.ajaxJSON(this.options.sections_url,"GET",{},this.gotSections)).then(function(t){var n,o,a,u,l,d,h,m,g;return m=t[0],h=t[1],g=t[2],r.gotChunkOfStudents(m),d=g.getResponseHeader("Link"),a=d.match(/<[^>]+>; *rel="last"/),null==a?void i.resolve():(u=a[0].match(/page=(\d+)/)[1],u=parseInt(u,10),1===u?void i.resolve():(o=function(t){return c.ajaxJSON(r.options[s],"GET",{page:t})},n=function(){var t,e;for(e=[],l=t=2;u>=2?u>=t:t>=u;l=u>=2?++t:--t)e.push(o(l));return e}(),c.when.apply(c,n).then(function(){var t,s,o,a,u,l;if(t=1<=arguments.length?e.call(arguments,0):[],1===n.length)r.gotChunkOfStudents(t[0]);else for(a=0,u=t.length;u>a;a++)l=t[a],m=l[0],s=l[1],o=l[2],r.gotChunkOfStudents(m);return i.resolve()})))}),o=this.getCustomColumns(),this.gotAllData=c.when(o,i),this.allSubmissionsLoaded.done(function(){var t,e,n,s,i;for(i=r.customColumns,n=0,s=i.length;s>n;n++)t=i[n],e=r.options.custom_column_data_url.replace(/:id/,t.id),r.getCustomColumnData(t.id);return ENV.GRADEBOOK_OPTIONS.differentiated_assignments_enabled?r.assignment_visibility():void 0}),this.showCustomColumnDropdownOption()}var P,j;return j={assignment:{min:10,default_max:200,max:400},assignmentGroup:{min:35,default_max:200,max:400},total:{min:85,max:100}},P=2,g.prototype.hasSections=c.Deferred(),g.prototype.allSubmissionsLoaded=c.Deferred(),g.prototype.assignment_visibility=function(){var t,e,n,s,i,o,r;e=m.keys(this.students),o=this.assignments,r=[];for(n in o)t=o[n],t.only_visible_to_overrides?(s=this.hiddenStudentIdsForAssignment(e,t),r.push(function(){var t,e,o;for(o=[],t=0,e=s.length;e>t;t++)i=s[t],o.push(this.updateSubmission({assignment_id:n,user_id:i,hidden:!0}));return o}.call(this))):r.push(void 0);return r},g.prototype.hiddenStudentIdsForAssignment=function(t,e){return m.difference(t,e.assignment_visibility.map(String))},g.prototype.onShow=function(){return this.startedInitializing?void 0:(this.startedInitializing=!0,this.spinner||(this.spinner=new C),c(this.spinner.spin().el).css({opacity:.5,top:"55px",left:"50%"}).addClass("use-css-transitions-for-show-hide").appendTo("#main"),c("#gradebook-grid-wrapper").hide(),this.gotAllData.done(this.doSlickgridStuff))},g.prototype.getCustomColumns=function(){var t=this;return c.getJSON(this.options.custom_columns_url).then(function(e){return t.numberOfFrozenCols+=e.length,t.customColumns=e})},g.prototype.getCustomColumnData=function(t,e){var n=this;return e||(e=this.options.custom_column_data_url.replace(/:id/,t)),c.getJSON(e).done(function(e,s,i){var o,r,a,u,l;for(r=i.getResponseHeader("Link").match(/<([^>]+)>; *rel="next"/),r&&n.getCustomColumnData(t,r[1]),u=0,l=e.length;l>u;u++)o=e[u],a=n.student(o.user_id),a["custom_col_"+t]=o.content,n.grid.invalidateRow(a.row);return n.grid.render()})},g.prototype.initPostGrades=function(){var t=this;return c("#post-grades-button").click(function(e){var n,s,i,o;return e.preventDefault(),s={assignments:t.assignments,course_id:ENV.GRADEBOOK_OPTIONS.context_id},t.sectionToShow?s.integration_section_id=t.sections[t.sectionToShow].integration_id:s.integration_course_id=ENV.GRADEBOOK_OPTIONS.context_integration_id,o=new x(s),i=new O(o,ENV.GRADEBOOK_OPTIONS.sis_app_url,ENV.GRADEBOOK_OPTIONS.sis_app_token),o.reset_ignored_assignments(),i.render().show(),n=c("#post-grades-container").dialog("isOpen")})},g.prototype.doSlickgridStuff=function(){return this.initGrid(),this.buildRows(),this.getSubmissionsChunks(),this.initHeader()},g.prototype.gotAssignmentGroups=function(t){var e,n,s,i,o;for(this.assignmentGroups={},this.assignments={},new y({context:this.options,assignmentGroups:t}),o=[],s=0,i=t.length;i>s;s++)n=t[s],this.assignmentGroups[n.id]=n,ENV.GRADEBOOK_OPTIONS.draft_state_enabled&&(n.assignments=m.select(n.assignments,function(t){return t.published})),o.push(function(){var t,s,i,o;for(i=n.assignments,o=[],t=0,s=i.length;s>t;t++)e=i[t],T(e),e.assignment_group=n,e.due_at=p.parse(e.due_at),o.push(this.assignments[e.id]=e);return o}.call(this));return o},g.prototype.gotSections=function(t){var e,n,s;for(this.sections={},n=0,s=t.length;s>n;n++)e=t[n],T(e),this.sections[e.id]=e;return this.displayPostGradesButton(this.sectionToShow),this.sections_enabled=t.length>1,this.hasSections.resolve()},g.prototype.gotChunkOfStudents=function(t){var e,n,s,i,o,r,a,u,l,d;for(d=[],r=0,a=t.length;a>r;r++)n=t[r],e=n.user,e.enrollment=n,"StudentViewEnrollment"===e.enrollment.role?(s=this.studentViewStudents)[u=e.id]||(s[u]=T(e)):(i=this.students)[l=e.id]||(i[l]=T(e)),(o=this.student(e.id)).sections||(o.sections=[]),d.push(this.student(e.id).sections.push(n.course_section_id));return d},g.prototype.gotAllStudents=function(){var t=this;return this.withAllStudents(function(e){var n,s,i,o,r,a,u,l,d,h;h=[];for(u in e){a=e[u],a.computed_current_score||(a.computed_current_score=0),a.computed_final_score||(a.computed_final_score=0),a.secondary_identifier=a.sis_login_id||a.login_id,t.sections_enabled&&(i=function(){var t,e,n,s;for(n=a.sections,s=[],t=0,e=n.length;e>t;t++)o=n[t],this.sections[o]&&s.push(this.sections[o].name);return s}.call(t),r=c.toSentence(i.sort())),a.display_name=N({avatar_url:a.avatar_url,display_name:a.name,url:a.enrollment.grades.html_url+"#tab-assignments",sectionNames:r,alreadyEscaped:!0}),d=t.assignments;for(s in d)n=d[s],a[l="assignment_"+s]||(a[l]={assignment_id:s,user_id:u});h.push(t.rows.push(a))}return h})},g.prototype.defaultSortType="assignment_group",g.prototype.studentsThatCanSeeAssignment=function(t,n){return ENV.GRADEBOOK_OPTIONS.differentiated_assignments_enabled?m.pick.apply(m,[t].concat(e.call(n.assignment_visibility))):t},g.prototype.getStoredSortOrder=function(){return f.contextGet("sort_grade_columns_by")||{sortType:this.defaultSortType}},g.prototype.setStoredSortOrder=function(t){return t.sortType===this.defaultSortType?f.contextRemove("sort_grade_columns_by"):f.contextSet("sort_grade_columns_by",t)},g.prototype.onColumnsReordered=function(){var t,e,n,s,i,o=this;return e=this.grid.getColumns(),n=m(this.customColumns).map(function(t){return t.id}),i=function(){var n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],(s=t.id.match(/^custom_col_(\d+)/))&&o.push(s[1]);return o}(),m.isEqual(i,n)?this.storeCustomColumnOrder():this.reorderCustomColumns(i).then(function(){var t;return t=m(o.customColumns).indexBy(function(t){return t.id}),o.customColumns=m(i).map(function(e){return t[e]})})},g.prototype.reorderCustomColumns=function(t){return c.ajaxJSON(this.options.reorder_custom_columns_url,"POST",{order:t})},g.prototype.storeCustomColumnOrder=function(){var t,e,n;return n={sortType:"custom",customOrder:[]},e=this.grid.getColumns(),t=m.filter(e,function(t){return"assignment"===t.type}),n.customOrder=m.map(t,function(t){return t.object.id}),this.setStoredSortOrder(n)},g.prototype.setArrangementTogglersVisibility=function(t){return this.$columnArrangementTogglers.each(function(){return c(this).closest("li").showIf(c(this).data("arrangeColumnsBy")!==t.sortType)})},g.prototype.arrangeColumnsBy=function(t){var n,s;return this.setArrangementTogglersVisibility(t),this.setStoredSortOrder(t),n=this.grid.getColumns(),s=n.splice(0,this.numberOfFrozenCols),n.sort(this.makeColumnSortFn(t)),n.splice.apply(n,[0,0].concat(e.call(s))),this.grid.setColumns(n),this.fixColumnReordering(),this.buildRows()},g.prototype.makeColumnSortFn=function(t){var e;return e=function(){switch(t.sortType){case"assignment_group":case"alpha":return this.compareAssignmentPositions;case"due_date":return this.compareAssignmentDueDates;case"custom":return this.makeCompareAssignmentCustomOrderFn(t);default:throw"unhandled column sort condition"}}.call(this),this.wrapColumnSortFn(e)},g.prototype.compareAssignmentPositions=function(t,e){var n,s;return n=t.object.assignment_group.position-e.object.assignment_group.position,s=t.object.position-e.object.position,1e6*n+s},g.prototype.compareAssignmentDueDates=function(t,e){var n,s;return n=t.object.due_at?+t.object.due_at/1e3:Number.MAX_VALUE,s=e.object.due_at?+e.object.due_at/1e3:Number.MAX_VALUE,n===s?t.object.name===e.object.name?0:t.object.name>e.object.name?1:-1:n-s},g.prototype.makeCompareAssignmentCustomOrderFn=function(t){var e,n,s,i,o,r,a=this;for(s={},n=0,r=t.customOrder,i=0,o=r.length;o>i;i++)e=r[i],s[String(e)]=n,n+=1;return function(t,e){var n,i;return n=s[String(t.object.id)],i=s[String(e.object.id)],null!=n&&null!=i?n-i:null!=n&&null==i?-1:null!=i?1:a.compareAssignmentPositions(t,e)}},g.prototype.wrapColumnSortFn=function(t){return function(e,n){return"total_grade"===n.type?-1:"total_grade"===e.type?1:"assignment_group"===n.type&&"assignment_group"!==e.type?-1:"assignment_group"===e.type&&"assignment_group"!==n.type?1:"assignment_group"===e.type&&"assignment_group"===n.type?e.object.position-n.object.position:t(e,n)}},g.prototype.rowFilter=function(t){var e;return!this.sectionToShow||(e=this.sectionToShow,n.call(t.sections,e)>=0)},g.prototype.handleAssignmentMutingChange=function(t){var e,n;return n=this.grid.getColumnIndex("assignment_"+t.id),e=this.grid.getColumns()[n],e.name=this.assignmentHeaderHtml(t),this.grid.setColumns(this.grid.getColumns()),this.fixColumnReordering(),this.buildRows()},g.prototype.handleAssignmentGroupWeightChange=function(t){var e,n,s,i,o,r;for(s=this.grid.getColumns(),r=t.assignmentGroups,i=0,o=r.length;o>i;i++)e=r[i],n=m.findWhere(s,{id:"assignment_group_"+e.id}),n.name=this.assignmentGroupHtml(n.object.name,n.object.group_weight);return this.setAssignmentWarnings(),this.grid.setColumns(s),this.renderTotalHeader(),this.buildRows()},g.prototype.renderTotalHeader=function(){return this.totalHeader=new a({showingPoints:this.displayPointTotals,toggleShowingPoints:this.togglePointsOrPercentTotals.bind(this),weightedGroups:this.weightedGroups,totalColumnInFront:this.totalColumnInFront,moveTotalColumn:this.moveTotalColumn.bind(this)}),this.totalHeader.render()},g.prototype.moveTotalColumn=function(){return this.totalColumnInFront=!this.totalColumnInFront,f.contextSet("total_column_in_front",this.totalColumnInFront),window.location.reload()},g.prototype.assignmentGroupHtml=function(t,e){var n,s;return n=T(t),this.weightedGroups()?(s=d.toPercentage(e,{precision:2}),""+n+"<div class='assignment-points-possible'>\n  "+d.t("percent_of_grade","%{percentage} of grade",{percentage:s})+"\n</div>"):""+n},g.prototype.buildRows=function(){var t,e,n,s,i=this;this.rows.length=0,n=this.grid.getColumns();for(e in n)t=n[e],""+(null!=(s=t.object)?s.submission_types:void 0)=="attendance"&&(t.unselectable=!this.show_attendance,t.cssClass=this.show_attendance?"":"completely-hidden",this.$grid.find("#"+this.uid+t.id).showIf(this.show_attendance));return this.withAllStudents(function(){var t,n,s;n=i.students,s=[];for(e in n)t=n[e],t.row=-1,i.rowFilter(t)?(i.rows.push(t),s.push(i.calculateStudentGrade(t))):s.push(void 0);return s}),this.sortRowsBy(function(t,e){return i.localeSort(t.sortable_name,e.sortable_name)})},g.prototype.getSubmissionsChunks=function(){var t=this;return this.withAllStudents(function(e){var n,s,i,o,r,a,u;for(n=function(){var t;t=[];for(s in e)o=e[s],t.push(o);return t}(),u=[];;){if(a=n.slice(t.chunk_start,t.chunk_start+t.options.chunk_size),!a.length){t.allSubmissionsLoaded.resolve();break}i={student_ids:function(){var t,e,n;for(n=[],t=0,e=a.length;e>t;t++)r=a[t],n.push(r.id);return n}(),response_fields:["id","user_id","url","score","grade","submission_type","submitted_at","assignment_id","grade_matches_current_submission","attachments","late","workflow_state"]},c.ajaxJSON(t.options.submissions_url,"GET",i,t.gotSubmissionsChunk),u.push(t.chunk_start+=t.options.chunk_size)}return u})},g.prototype.gotSubmissionsChunk=function(t){var e,n,s,i,o,r,a,u,l,d;for(r=0,u=t.length;u>r;r++){for(n=t[r],i=this.student(n.user_id),d=n.submissions,a=0,l=d.length;l>a;a++)o=d[a],e=i["assignment_"+o.assignment_id],null!=e&&(s=e.hidden),s||this.updateSubmission(o);i.loaded=!0,this.grid.invalidateRow(i.row),this.calculateStudentGrade(i)}return this.grid.render()},g.prototype.student=function(t){return this.students[t]||this.studentViewStudents[t]},g.prototype.withAllStudents=function(t){var e,n,s,i,o;s=this.studentViewStudents;for(e in s)n=s[e],this.students[e]=n;t(this.students),i=this.studentViewStudents,o=[];for(e in i)n=i[e],o.push(delete this.students[e]);return o},g.prototype.updateSubmission=function(t){var e;return e=this.student(t.user_id),t.submitted_at=p.parse(t.submitted_at),e["assignment_"+t.assignment_id]=t},g.prototype.updateSubmissionsFromExternal=function(t){var e,n,s,i,o,r,a,u,l,d,h,m,g,p,_;for(e=this.grid.getActiveCell(),o=c(this.grid.getActiveCellNode()).hasClass("editable"),i=this.grid.getColumns(),_=[],h=0,g=t.length;g>h;h++){for(l=t[h],u=this.student(l.user_id),r="assignment_"+l.assignment_id,a=m=0,p=i.length;p>m;a=++m)s=i[a],s.id===r&&(n=a);d=null!=e&&o&&e.row===u.row&&e.cell===n,this.updateSubmission(l),this.calculateStudentGrade(u),d||this.grid.updateCell(u.row,n),_.push(this.updateRowTotals(u.row))}return _},g.prototype.updateRowTotals=function(t){var e,n,s,i,o,r;for(s=this.grid.getColumns(),r=[],n=i=0,o=s.length;o>i;n=++i)e=s[n],r.push("assignment"!==e.type?this.grid.updateCell(t,n):void 0);return r},g.prototype.cellFormatter=function(t,e,n){var s;return this.rows[t].loaded?n.hidden?this.uneditableCellFormatter(t,e):null==n?this.staticCellFormatter(t,e,"-"):(s=this.assignments[n.assignment_id],null==s?this.staticCellFormatter(t,e,""):"points"===s.grading_type&&s.points_possible?v.out_of.formatter(t,e,n,s):(v[s.grading_type]||v).formatter(t,e,n,s)):this.staticCellFormatter(t,e,"")},g.prototype.staticCellFormatter=function(t,e,n){return"<div class='cell-content gradebook-cell'>"+n+"</div>"},g.prototype.uneditableCellFormatter=function(){return"<div class='cell-content gradebook-cell grayed-out'></div>"},g.prototype.groupTotalFormatter=function(t,e,n,s){var i,o,r;return null==n?"":(o=Math.round(n.score/n.possible*1e3)/10,isNaN(o)&&(o=0),n.possible&&this.options.grading_standard&&"total_grade"===s.type&&(i=_.letter_grade(this.options.grading_standard,o)),r={score:u(n.score,P),possible:u(n.possible,P),letterGrade:i,percentage:o},"total_grade"===s.type&&(r.warning=this.totalGradeWarning,r.lastColumn=!0,r.showPointsNotPercent=this.displayPointTotals(),r.hideTooltip=this.weightedGroups()&&!this.totalGradeWarning),A(r))},g.prototype.htmlContentFormatter=function(t,e,n){return null==n?"":n},g.prototype.calculateStudentGrade=function(t){var e,n,s,i,o,r,a,u,l,d,h,c,m;if(t.loaded){for(e=this.include_ungraded_assignments?"final":"current",r=function(){var e;e=[];for(s in t)a=t[s],s.match(/^assignment_(?!group)/)&&e.push(a);return e}(),i=_.calculate(r,this.assignmentGroups,this.options.group_weighting_scheme),c=i.group_sums,u=0,d=c.length;d>u;u++)for(n=c[u],t["assignment_group_"+n.group.id]=n[e],m=n[e].submissions,l=0,h=m.length;h>l;l++)o=m[l],o.submission.drop=o.drop;return t.total_grade=i[e],this.addDroppedClass(t)}},g.prototype.addDroppedClass=function(t){var e,n,s,i,o,r,a,u;for(s=function(){var e;e=[];for(o in t)n=t[o],o.match(/assignment_\d+/)&&null!=n.drop&&e.push(o);return e}(),i={},i[t.row]={},a=0,u=s.length;u>a;a++)e=s[a],i[t.row][e]="dropped";return r="dropsForRow"+t.row,this.grid.removeCellCssStyles(r),this.grid.addCellCssStyles(r,i)},g.prototype.highlightColumn=function(t){var e,n,s;return e=this.$grid.find(".slick-header-column"),e.filter(".slick-sortable-placeholder").length?void 0:(n=this.grid.getCellFromEvent(t),s=this.grid.getColumns()[n.cell],e.filter("#"+this.uid+s.id).addClass("hovered-column"))},g.prototype.unhighlightColumns=function(){return this.$grid.find(".hovered-column").removeClass("hovered-column")},g.prototype.fixColumnReordering=function(){var t,e,n,s,i,o,r,a=this;return t=c("#gradebook_grid .container_1").find(".slick-header-columns"),o=t.sortable("option","items"),i='> *:not([id*="assignment_group"]):not([id*="total_grade"])',(s=function(){var e;return t.sortable("option","items",i),e=c(o,t).not(c(i,t)),e.data("sortable-item",null)})(),(n=function(){return t.find(".assignment_header_drop").click(function(t){var e;return e=c(t.target),e.data("gradebookHeaderMenu")||e.data("gradebookHeaderMenu",new S(a.assignments[e.data("assignmentId")],e,a)),!1})})(),r=t.sortable("option","stop"),(e=function(){return t.sortable("option","stop",function(){var i;return t.sortable("option","items",o),i=r.apply(this,arguments),s(),n(),e(),i})})()},g.prototype.minimizeColumn=function(t){var e,n;return n=t.data("column"),e=this.grid.getColumnIndex(n.id),n.cssClass=(n.cssClass||"").replace(" minimized","")+" minimized",n.unselectable=!0,n.unminimizedName=n.name,n.name="",n.minimized=!0,this.$grid.find(".l"+e).add(t).addClass("minimized"),this.assignmentsToHide.push(n.id),f.contextSet("hidden_columns",m.uniq(this.assignmentsToHide))},g.prototype.unminimizeColumn=function(t){var e,n;return n=t.data("column"),e=this.grid.getColumnIndex(n.id),n.cssClass=(n.cssClass||"").replace(" minimized",""),n.unselectable=!1,n.name=n.unminimizedName,n.minimized=!1,this.$grid.find(".l"+e).add(t).removeClass("minimized"),t.find(".slick-column-name").html(n.name),this.assignmentsToHide=c.grep(this.assignmentsToHide,function(t){return t!==n.id}),f.contextSet("hidden_columns",m.uniq(this.assignmentsToHide))},g.prototype.hoverMinimizedCell=function(t){var e,n,s,i,o,r,a,u;return e=c(t.currentTarget).removeClass("hover"),(s=this.grid.getCellFromEvent(t))?(i=this.grid.getColumns()[s.cell],n=i.object,r=e.offset(),o=[n.name],e.hasClass("slick-cell")?(a=this.rows[s.row][i.id],null!=n.points_possible?o.push(""+(null!=(u=a.score)?u:"--")+" / "+n.points_possible):null!=a.score&&o.push(a.score),Array.prototype.push.apply(o,c.map(v.classesBasedOnSubmission(a,n),function(t){return h["#submission_tooltip_"+t]}))):null!=n.points_possible&&o.push(d.t("points_out_of","out of %{points_possible}",{points_possible:n.points_possible})),e.data("tooltip",c("<span />",{"class":"gradebook-tooltip",css:{left:r.left-15,top:r.top,zIndex:1e4,display:"block"},html:o.join("<br />")}).appendTo("body").css("top",function(t,e){return parseInt(e)-c(this).outerHeight()}))):void 0},g.prototype.unhoverMinimizedCell=function(t){var e;return(e=c(this).data("tooltip"))?t.toElement===e[0]?e.mouseleave(function(){return e.remove()}):e.remove():void 0},g.prototype.fixMaxHeaderWidth=function(){return this.$grid.find(".slick-header-columns").width(1e6)},g.prototype.onGridBlur=function(t){return t.target.className.match(/cell|slick/)||!this.grid.getActiveCell||"grade"===t.target.className&&this.grid.getCellEditor()instanceof v.out_of||c(t.target).is(".dontblur,.dontblur *")?void 0:this.grid.getEditorLock().commitCurrentEdit()},g.prototype.onGridInit=function(){var t,e,n,s=this;return n={},c(this.spinner.el).remove(),c("#gradebook-grid-wrapper").show(),this.uid=this.grid.getUID(),c("#content").focus(function(){return c("#accessibility_warning").removeClass("screenreader-only")}),c("#accessibility_warning").focus(function(){return c("#accessibility_warning").blur(function(){return c("#accessibility_warning").remove()})}),this.$grid=t=c("#gradebook_grid").fillWindowWithMe({onResize:function(){return s.grid.resizeCanvas()}}).delegate(".slick-cell",{"mouseenter.gradebook focusin.gradebook":this.highlightColumn,"mouseleave.gradebook focusout.gradebook":this.unhighlightColumns,"mouseenter focusin":function(e){return t.find(".hover, .focus").removeClass("hover focus"),"0px"===c(this).parent().css("top")&&c(this).find("div.gradebook-tooltip").addClass("first-row"),c(this).addClass("mouseenter"===e.type?"hover":"focus")},"mouseleave focusout":function(){return c(this).removeClass("hover focus"),c(this).find("div.gradebook-tooltip").removeClass("first-row")}}).delegate(".gradebook-cell-comment","click.gradebook",function(t){var e;return t.preventDefault(),e=c(t.currentTarget).data(),c(s.grid.getActiveCellNode()).removeClass("editable"),b.open(s.assignments[e.assignmentId],s.student(e.userId.toString()),s.options)}).delegate(".minimized",{mouseenter:this.hoverMinimizedCell,mouseleave:this.unhoverMinimizedCell}),this.options.gradebook_is_editable&&this.$grid.addClass("editable"),this.fixMaxHeaderWidth(),this.grid.onColumnsResized.subscribe(function(){return s.$grid.find(".slick-header-column").each(function(t,e){var n,i;if(n=c(e),i=n.data("column"),"assignment"===i.type)if(n.outerWidth()<=j.assignment.min){if(!i.minimized)return s.minimizeColumn(n)}else if(i.minimized)return s.unminimizeColumn(n)})}),this.keyboardNav=new D(this.grid,this.$grid),this.keyboardNav.init(),e=this.keyboardNav.keyBindings,this.kbDialog=(new i).render(o({keyBindings:e})),c(document).on("dialogclose",function(){return setTimeout(function(){return s.grid.editActiveCell()},0)}),c(document).trigger("gridready")},g.prototype.sectionList=function(){var t=this;return m.map(this.sections,function(e,n){return{name:e.name,id:n,checked:t.sectionToShow===n}})},g.prototype.drawSectionSelectButton=function(){return this.sectionMenu=new R({el:c(".section-button-placeholder"),sections:this.sectionList(),currentSection:this.sectionToShow}),this.sectionMenu.render()},g.prototype.updateCurrentSection=function(t){return this.sectionToShow=t,this.displayPostGradesButton(t),f[this.sectionToShow?"contextSet":"contextRemove"]("grading_show_only_section",this.sectionToShow),this.grid?this.buildRows():void 0},g.prototype.displayPostGradesButton=function(t){var e,n;return null!=t?n=this.sections[t]&&this.sections[t].integration_id:e=ENV.GRADEBOOK_OPTIONS.context_integration_id,n||e?this.showPostGradesButton():this.hidePostGradesButton()},g.prototype.hidePostGradesButton=function(){return c("#post-grades-button").closest(".gradebook-navigation").addClass("hidden")},g.prototype.showPostGradesButton=function(){return c("#post-grades-button").closest(".gradebook-navigation").removeClass("hidden")},g.prototype.initHeader=function(){var t,e=this;return this.sections_enabled&&this.drawSectionSelectButton(),t=c("#gradebook_settings").next(),c.each(["show_attendance","include_ungraded_assignments","show_concluded_enrollments"],function(n,s){return t.find("#"+s).prop("checked",!!e[s]).change(function(n){return"show_concluded_enrollments"===s&&e.options.course_is_concluded&&e.show_concluded_enrollments?(c("#"+s).prop("checked",!0),t.menu("refresh"),alert(d.t("concluded_course_error_message","This is a concluded course, so only concluded enrollments are available."))):(e[s]=c(n.target).is(":checked"),f.contextSet(s,e[s]),"show_concluded_enrollments"===s&&window.location.reload(),"show_attendance"===s&&e.grid.setColumns(e.getVisibleGradeGridColumns()),e.buildRows())})}),m.detect(this.assignments,function(t){return""+t.submission_types=="attendance"})||t.find("#show_attendance").closest("li").hide(),this.$columnArrangementTogglers=c("#gradebook-toolbar [data-arrange-columns-by]").bind("click",function(t){var n;return t.preventDefault(),n={sortType:c(t.currentTarget).data("arrangeColumnsBy")},e.arrangeColumnsBy(n)}),this.arrangeColumnsBy(this.getStoredSortOrder()),c("#gradebook_settings").show().kyleMenu(),t.find(".gradebook_upload_link").click(function(t){return t.preventDefault(),new G(e.options.context_url)}),t.find(".student_names_toggle").click(this.studentNamesToggle),this.userFilter=new l({el:".gradebook_filter input"}),this.userFilter.on("input",this.onUserFilterInput),this.initPostGrades(),this.setDownloadCsvUrl(),this.renderTotalHeader()},g.prototype.setDownloadCsvUrl=function(){return this.show_concluded_enrollments?c("#download_csv")[0].href+="?include_priors=true":void 0},g.prototype.studentNamesToggle=function(t){var e;return t.preventDefault(),e=this.$grid.find(".grid-canvas"),e.toggleClass("hide-students"),c(t.currentTarget).text(e.hasClass("hide-students")?d.t("show_student_names","Show Student Names"):d.t("hide_student_names","Hide Student Names"))},g.prototype.weightedGroups=function(){return"percent"===this.options.group_weighting_scheme},g.prototype.displayPointTotals=function(){return this.weightedGroups()?!1:this.options.show_total_grade_as_points},g.prototype.switch_total_display=function(){return this.options.show_total_grade_as_points=!this.options.show_total_grade_as_points,c.ajaxJSON(this.options.setting_update_url,"PUT",{show_total_grade_as_points:this.displayPointTotals()}),this.grid.invalidate(),this.totalHeader.render()},g.prototype.switch_total_display_and_mark_user_as_warned=function(){return f.contextSet("warned_about_totals_display",!0),this.switch_total_display()},g.prototype.togglePointsOrPercentTotals=function(){var t;return f.contextGet("warned_about_totals_display")?this.switch_total_display():(t={showing_points:this.options.show_total_grade_as_points,unchecked_save:this.switch_total_display,checked_save:this.switch_total_display_and_mark_user_as_warned},new w(t))},g.prototype.onUserFilterInput=function(t){var e,n,s,i,o,r,a,u;if(e=this.grid.getData(),m.each(e,function(t){return null!=t.beforeFilteredRow?(t.row=t.beforeFilteredRow,delete t.beforeFilteredRow):void 0}),m.each(this.userFilterRemovedRows.reverse(),function(t){return e.splice(t.index,0,t.data)}),this.userFilterRemovedRows=[],""!==t)for(o=["name","login_id","short_name","sortable_name"],n=e.length;n--;)r=e[n],i=m.any(o,function(e){var n;return null!=(n=r[e])?n.match(new RegExp(t,"i")):void 0}),i||(s={index:n,data:e.splice(n,1)[0]},this.userFilterRemovedRows.push(s));for(n=a=0,u=e.length;u>a;n=++a)r=e[n],r.beforeFilteredRow=r.row,r.row=n;return this.grid.setData(e),this.grid.invalidate()},g.prototype.getVisibleGradeGridColumns=function(){var t,e,n,s,i,o;for(e=[].concat(this.parentColumns,this.customColumnDefinitions()),o=this.allAssignmentColumns,s=0,i=o.length;i>s;s++)t=o[s],n=""+t.object.submission_types,"not_graded"===n||"attendance"===n&&!this.show_attendance||e.push(t);return e.concat(this.aggregateColumns)},g.prototype.assignmentHeaderHtml=function(t){return F({assignment:t,href:t.html_url,showPointsPossible:null!=t.points_possible})
},g.prototype.customColumnDefinitions=function(){return this.customColumns.map(function(t){return{id:"custom_col_"+t.id,name:T(t.title),field:"custom_col_"+t.id,width:100,cssClass:"meta-cell custom_column",resizable:!0,sortable:!0,editor:s,autoEdit:!1,maxLength:255}})},g.prototype.initGrid=function(){var t,e,s,i,o,a,u,l,h,m,g,p,_=this;return t=c('<span style="padding:10px" />').appendTo("#content"),m=function(e,n,s){var i;return i=Math.max(t.text(e).outerWidth(),n),Math.min(i,s)},this.setAssignmentWarnings(),this.parentColumns=[{id:"student",name:d.t("student_name","Student Name"),field:"display_name",width:150,cssClass:"meta-cell",resizable:!0,sortable:!0,formatter:this.htmlContentFormatter},{id:"secondary_identifier",name:d.t("secondary_id","Secondary ID"),field:"secondary_identifier",width:100,cssClass:"meta-cell secondary_identifier_cell",resizable:!0,sortable:!0,formatter:this.htmlContentFormatter}],this.allAssignmentColumns=function(){var t,o,r=this;t=this.assignments,o=[];for(a in t)e=t[a],h=e&&"points"===e.grading_type&&null!=e.points_possible&&v.out_of,u=h?70:90,i="assignment_"+a,s={id:i,field:i,name:this.assignmentHeaderHtml(e),object:e,formatter:this.cellFormatter,editor:h||v[e.grading_type]||v,minWidth:j.assignment.min,maxWidth:j.assignment.max,width:m(e.name,u,j.assignment.default_max),sortable:!0,toolTip:e.name,type:"assignment"},n.call(this.assignmentsToHide,i)>=0&&(s.width=10,function(t){return c(document).bind("gridready",function(){return r.minimizeColumn(r.$grid.find("#"+r.uid+t))}).unbind("gridready.render").bind("gridready.render",function(){return r.grid.invalidate()})}(i)),o.push(s);return o}.call(this),this.aggregateColumns=function(){var t,e;t=this.assignmentGroups,e=[];for(a in t)o=t[a],e.push({id:"assignment_group_"+a,field:"assignment_group_"+a,formatter:this.groupTotalFormatter,name:this.assignmentGroupHtml(o.name,o.group_weight),toolTip:o.name,object:o,minWidth:j.assignmentGroup.min,maxWidth:j.assignmentGroup.max,width:m(o.name,j.assignmentGroup.min,j.assignmentGroup.default_max),cssClass:"meta-cell assignment-group-cell",sortable:!0,type:"assignment_group"});return e}.call(this),g=d.t("total","Total"),p={id:"total_grade",field:"total_grade",formatter:this.groupTotalFormatter,name:""+g+"\n<div id=total_column_header></div>",toolTip:g,minWidth:j.total.min,maxWidth:j.total.max,width:m("Total",j.total.min,j.total.max),cssClass:this.totalColumnInFront?"meta-cell":"total-cell",sortable:!0,type:"total_grade"},(this.totalColumnInFront?this.parentColumns:this.aggregateColumns).push(p),t.remove(),l=c.extend({enableCellNavigation:!0,enableColumnReorder:!0,enableAsyncPostRender:!0,asyncPostRenderDelay:1,autoEdit:!0,editable:this.options.gradebook_is_editable,syncColumnCellResize:!0,rowHeight:35,headerHeight:38,numberOfColumnsToFreeze:this.numberOfFrozenCols},this.options),this.grid=new r.Grid("#gradebook_grid",this.rows,this.getVisibleGradeGridColumns(),l),this.grid.setSortColumn("student"),this.grid.onCellChange.subscribe(this.onCellChange),c("body").on("click",this.onGridBlur),this.grid.onSort.subscribe(function(t,e){var n;return"display_name"===e.sortCol.field||"secondary_identifier"===e.sortCol.field||e.sortCol.field.match(/^custom_col/)?(n="display_name"===e.sortCol.field?"sortable_name":e.sortCol.field,_.sortRowsBy(function(t,s){var i;return e.sortAsc||(i=[t,s],s=i[0],t=i[1]),_.localeSort(t[n],s[n])})):_.sortRowsBy(function(t,n){return _.gradeSort(t,n,e.sortCol.field,e.sortAsc)})}),this.grid.onKeyDown.subscribe(function(){return!1}),this.grid.onColumnsReordered.subscribe(this.onColumnsReordered),this.grid.onBeforeEditCell.subscribe(this.onBeforeEditCell),this.onGridInit()},g.prototype.onBeforeEditCell=function(t,e){var n,s,i;return i=e.row,s=e.cell,n=this.grid.getCellNode(i,s),c(n).find(".gradebook-cell").hasClass("grayed-out")?!1:void 0},g.prototype.onCellChange=function(t,e){var n,s,i,o;return i=e.item,s=e.column,(n=s.field.match(/^custom_col_(\d+)/))?(o=this.options.custom_column_datum_url.replace(/:id/,n[1]).replace(/:user_id/,i.id),c.ajaxJSON(o,"PUT",{"column_data[content]":i[s.field]})):(this.calculateStudentGrade(i),this.grid.invalidate())},g.prototype.sortRowsBy=function(t){var e,n,s,i,o,r,a=this;for(n=function(){return m(a.studentViewStudents).size()?function(e,n){return a.studentViewStudents[e.id]?1:a.studentViewStudents[n.id]?-1:t(e,n)}:t},this.rows.sort(n()),r=this.rows,e=i=0,o=r.length;o>i;e=++i)s=r[e],s.row=e,this.addDroppedClass(s);return this.grid.invalidate()},g.prototype.localeSort=function(t,e){return(t||"").localeCompare(e||"",window.I18n.locale,{sensitivity:"accent",numeric:!0})},g.prototype.gradeSort=function(t,e,n,s){var i,o=this;return i=function(t){var e;switch(e=function(t){return t[n].possible>0?t[n].score/t[n].possible:null},!1){case"total_grade"!==n:return o.options.show_total_grade_as_points?t[n].score:e(t);case!n.match(/^assignment_group/):return e(t);default:return t[n].score}},k(i(t),i(e),{descending:!s})},g.prototype.setAssignmentWarnings=function(){var t,e,n,s,i,o,r,a,u,l;if(!this.weightedGroups())return i=m.inject(this.assignments,function(t,e){return t+(e.points_possible||0)},0),this.totalGradeWarning=0===i?d.t("no_assignments_have_points_warning","Can't compute score until an assignment has points possible"):null;for(s=m.filter(this.assignmentGroups,function(t){var e;return e=m.inject(t.assignments,function(t,e){return t+(e.points_possible||0)},0),0===e}),o=0,a=s.length;a>o;o++)for(e=s[o],l=e.assignments,r=0,u=l.length;u>r;r++)t=l[r],t.invalid=!0;return s.length>0?(n=function(){var t,n,i;for(i=[],t=0,n=s.length;n>t;t++)e=s[t],i.push(e.name);return i}(),this.totalGradeWarning=d.t("invalid_assignment_groups_warning",{one:"Score does not include %{groups} because it has                  no points possible",other:"Score does not include %{groups} because they have                    no points possible"},{groups:c.toSentence(n),count:n.length})):void 0},g.prototype.showCustomColumnDropdownOption=function(){var t,n,s,i,o,r,a,u,l,h,m,g,p,_=this;return r=c("<li>").appendTo(".gradebook_drop_down"),u=d.t("show_notes","Show Notes Column"),s=d.t("hide_notes","Hide Notes Column"),g=function(){return _.options.custom_column_url.replace(/:id/,_.options.teacher_notes.id)},t=c("<a>",{href:this.options.custom_columns_url,"class":"create",text:u}),l=function(){return c("<a>",{href:g(),"class":"show",text:u})},i=function(){return c("<a>",{href:g(),"class":"hide",text:s})},n=function(t,e,n){return c.ajaxJSON(t.target.href,e,n)},p=function(t){var n,s;return s=_.numberOfFrozenCols,t(),n=_.grid.getColumns(),n.splice.apply(n,[0,s].concat(e.call(_.parentColumns),e.call(_.customColumnDefinitions()))),_.grid.setColumns(n),_.grid.invalidate()},m=!1,h=function(){return m||_.getCustomColumnData(_.options.teacher_notes.id),p(function(){return _.customColumns.splice(0,0,_.options.teacher_notes),_.grid.setNumberOfColumnsToFreeze(++_.numberOfFrozenCols)}),r.html(i())},o=function(){return p(function(){var t,e,n,s,i;for(i=_.customColumns,e=n=0,s=i.length;s>n;e=++n)if(t=i[e],t.teacher_notes){_.customColumns.splice(e,1),_.numberOfFrozenCols-=1;break}return _.grid.setNumberOfColumnsToFreeze(_.numberOfFrozenCols)}),r.html(l())},r.click(function(t){var e;return t.preventDefault(),e=c(t.target),e.hasClass("show")&&n(t,"PUT",{"column[hidden]":!1}).then(function(){return h(),_.reorderCustomColumns(_.customColumns.map(function(t){return t.id}))}),e.hasClass("hide")&&n(t,"PUT",{"column[hidden]":!0}).then(o()),e.hasClass("create")?n(t,"POST",{"column[title]":d.t("notes","Notes"),"column[position]":1,"column[teacher_notes]":!0}).then(function(t){return _.options.teacher_notes=t,h()}):void 0}),a=this.options.teacher_notes,r.html(a?a.hidden?l():i():t)},g.prototype.alignCoursePreferencesWithLocalStorage=function(){var t;return t=f.contextGet("show_point_totals"),t&&t!==this.options.show_total_grade_as_points?(this.options.show_total_grade_as_points=t,f.contextRemove("show_point_totals"),c.ajaxJSON(this.options.setting_update_url,"PUT",{show_total_grade_as_points:this.options.show_total_grade_as_points})):void 0},g}()})}).call(this);