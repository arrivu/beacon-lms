(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","underscore","timezone","compiled/calendar/commonEventFactory","compiled/calendar/TimeBlockList","jst/calendar/editCalendarEvent","jquery.instructure_date_and_time","jquery.instructure_forms","jquery.instructure_misc_helpers","vendor/date"],function(e,i,n,a,r,o){var s;return s=function(){function r(i,n,a,r){this.event=n,this.contextChangeCB=a,this.closeCB=r,this.formSubmit=t(this.formSubmit,this),this.setupTimeAndDatePickers=t(this.setupTimeAndDatePickers,this),this.contextChange=t(this.contextChange,this),this.setContext=t(this.setContext,this),this.moreOptionsClick=t(this.moreOptionsClick,this),this.getFormData=t(this.getFormData,this),this.activate=t(this.activate,this),this.currentContextInfo=null,this.form=e(o({title:this.event.title,contexts:this.event.possibleContexts(),lockedTitle:this.event.lockedTitle,location_name:this.event.location_name})),e(i).append(this.form),this.setupTimeAndDatePickers(),this.form.submit(this.formSubmit),this.form.find(".more_options_link").click(this.moreOptionsClick),this.form.find("select.context_id").change(this.contextChange),this.form.find("select.context_id").triggerHandler("change",!1),this.event.isNewEvent()||this.form.find(".context_select").hide()}return r.prototype.contextInfoForCode=function(t){var e,i,n,a;for(a=this.event.possibleContexts(),i=0,n=a.length;n>i;i++)if(e=a[i],e.asset_string===t)return e;return null},r.prototype.activate=function(){return this.form.find("select.context_id").change()},r.prototype.getFormData=function(){var t,e,a,r,o,s;return t=this.form.getFormData({object_name:"calendar_event"}),t=i.omit(t,"date","start_time","end_time"),e=this.form.find("input[name=date]").data("date"),e&&(s=this.form.find("input[name=start_time]").data("date"),o=e.toString("yyyy-MM-dd"),s&&(o+=s.toString(" HH:mm")),t.start_at=n.parse(o),r=this.form.find("input[name=end_time]").data("date"),a=e.toString("yyyy-MM-dd"),r&&(a+=r.toString(" HH:mm")),t.end_at=n.parse(a)),t},r.prototype.moreOptionsClick=function(t){var i,n,a;if(!this.event.object.parent_event_id)return t.preventDefault(),n={return_to:window.location.href},i=this.getFormData(),i.start_date=this.form.find("input[name=date]").val(),i.start_time=this.form.find("input[name=start_time]").val(),i.end_time=this.form.find("input[name=end_time]").val(),i.title&&(n.title=i.title),i.location_name&&(n.location_name=i.location_name),i.start_date&&(n.start_date=i.start_date),i.start_time&&(n.start_time=i.start_time),i.end_time&&(n.end_time=i.end_time),a=e(t.target).attr("href").split("#"),a[0]+="?"+e.param(n),window.location.href=a.join("#")},r.prototype.setContext=function(t){return this.form.find("select.context_id").val(t).triggerHandler("change",!1)},r.prototype.contextChange=function(t,i){var n,a;return n=e(t.target).val(),this.currentContextInfo=this.contextInfoForCode(n),this.event.contextInfo=this.currentContextInfo,null!==this.currentContextInfo?(i!==!1&&this.contextChangeCB(n),a=null,a=this.event.isNewEvent()?this.currentContextInfo.new_calendar_event_url:this.event.fullDetailsURL()+"/edit",this.form.find(".more_options_link").attr("href",a)):void 0},r.prototype.setupTimeAndDatePickers=function(){var t,i,n=this;return this.form.find(".date_field").date_field(),this.form.find(".time_field").time_field().blur(function(t){var i,a,r,o;return o=n.form.find(".time_field.start_time").next(".datetime_suggest").text(),n.form.find(".time_field.start_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(o=null),null==o&&(o=n.form.find(".time_field.start_time").val()),a=n.form.find(".time_field.end_time").next(".datetime_suggest").text(),n.form.find(".time_field.end_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(a=null),null==a&&(a=n.form.find(".time_field.end_time").val()),r=Date.parse(o),i=Date.parse(a),r=r||i,i=i||r,e(t.target).hasClass("end_time")?r>i&&(r=i):r>i&&(i=r),r&&n.form.find(".time_field.start_time").val(r.toString("h:mmtt").toLowerCase()),i?n.form.find(".time_field.end_time").val(i.toString("h:mmtt").toLowerCase()):void 0}),i=this.event.startDate(),t=this.event.endDate(),this.event.allDay||(i&&this.form.find(".time_field.start_time").val(i.toString("h:mmtt")).change().blur(),t&&this.form.find(".time_field.end_time").val(t.toString("h:mmtt")).change().blur()),i?this.form.find(".date_field").val(i.toString("MMM d, yyyy")).change():void 0},r.prototype.formSubmit=function(t){var i,n,r,o,s,d;return t.preventDefault(),i=this.getFormData(),n=i.location_name||"",s={"calendar_event[title]":null!=(d=i.title)?d:this.event.title,"calendar_event[start_at]":i.start_at?i.start_at.toISOString():"","calendar_event[end_at]":i.end_at?i.end_at.toISOString():"","calendar_event[location_name]":n},this.event.isNewEvent()?(s["calendar_event[context_code]"]=i.context_code,o={calendar_event:{title:s["calendar_event[title]"],start_at:i.start_at?i.start_at.toISOString():null,end_at:i.end_at?i.end_at.toISOString():null,location_name:n,context_code:this.form.find(".context_id").val()}},r=a(o,this.event.possibleContexts()),r.save(s)):(this.event.title=s["calendar_event[title]"],this.event.start=e.fudgeDateForProfileTimezone(i.start_at),this.event.end=e.fudgeDateForProfileTimezone(i.end_at),this.event.location_name=n,this.event.save(s)),this.closeCB()},r}()})}).call(this);