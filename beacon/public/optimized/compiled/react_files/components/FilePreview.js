(function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define(["underscore","react","react-router","react-modal","../modules/customPropTypes","i18n!file_preview","./FriendlyDatetime","compiled/util/friendlyBytes","compiled/models/Folder","compiled/react/shared/utils/withReactDOM","../utils/collectionHandler","./FilePreviewFooter","./FilePreviewInfoPanel","../modules/filesEnv"],function(t,o,r,s,n,l,d,h,f,c,p,u,m,v){var w;return w=o.createClass({displayName:"FilePreview",mixins:[o.addons.PureRenderMixin,r.Navigation],propTypes:{currentFolder:n.folder,query:o.PropTypes.object,collection:o.PropTypes.object,params:o.PropTypes.object},getInitialState:function(){return{showInfoPanel:!1,showFooter:!1,showFooterBtn:!0,displayedItem:null}},componentWillMount:function(){var e;return e=this.getItemsToView(this.props),this.setState(this.stateProperties(e,this.props))},componentDidMount:function(){return $(".ReactModal__Overlay").on("keydown",this.handleKeyboardNavigation)},componentWillUnmount:function(){return $(".ReactModal__Overlay").off("keydown",this.handleKeyboardNavigation)},componentWillReceiveProps:function(e){var t;return t=this.getItemsToView(e),this.setState(this.stateProperties(t,e),this.scrollFooterToItem)},getItemsToView:function(i){var o,r,s,a,n,l,d;return n=null!=(d=i.query.only_preview)?d.split(","):void 0,a=!!i.query.search_term,a?(r=i.collection.models,o=r):(r=i.currentFolder,o=r.files),l=n?o.filter(function(t){var i;return i=t.id,e.call(n,i)>=0}):o,s=i.query.preview?a?t.find(r,function(e){return e.id===i.query.preview}):o.get(i.query.preview):l instanceof Backbone.Collection?l.first():t.first(l),{initialItem:s,otherItems:l}},stateProperties:function(e,t){return{initialItem:e.initialItem,displayedItem:e.initialItem,otherItems:e.otherItems,currentFolder:t.currentFolder,params:t.params,otherItemsString:t.query.only_preview?t.query.only_preview:void 0,otherItemsIsBackBoneCollection:e.otherItems instanceof Backbone.Collection}},scrollFooterToItem:function(){var e,t,i,o;return this.state.showFooter&&(e=$(".ef-file-preview-footer-active"),t=$(".ef-file-preview-footer-list"),o=t.offset(),i=e.offset(),i.left>o.left+t.width()&&t.scrollTo(e),i.left<o.left)?t.scrollTo(e):void 0},setUpOtherItemsQuery:function(e){return e.map(function(e){return e.id}).join(",")},getRouteIdentifier:function(){var e;return this.props.query.search_term?"search":(null!=(e=this.props.currentFolder)?e.urlPath():void 0)?"folder":"rootFolder"},getNavigationParams:function(i){var o;return null==i&&(i={id:null,except:[]}),o={preview:i.id?i.id:void 0,search_term:this.props.search_term?this.props.query.search_term:void 0,only_preview:this.state.otherItemsString?this.state.otherItemsString:void 0},t.each(o,function(t,r){var s;return!t||(null!=(s=i.except)?s.length:void 0)&&(i.except===r||e.call(i.except,r)>=0)?delete o[r]:void 0}),o},openInfoPanel:function(e){return e.preventDefault(),this.setState({showInfoPanel:!this.state.showInfoPanel})},toggleFooter:function(e){return e.preventDefault(),this.setState({showFooter:!this.state.showFooter})},handleKeyboardNavigation:function(e){var t;return e.keyCode!==$.ui.keyCode.LEFT&&e.keyCode!==$.ui.keyCode.RIGHT?null:(e.keyCode===$.ui.keyCode.LEFT&&(t=p.getPreviousInRelationTo(this.state.otherItems,this.state.displayedItem)),e.keyCode===$.ui.keyCode.RIGHT&&(t=p.getNextInRelationTo(this.state.otherItems,this.state.displayedItem)),this.transitionTo(this.getRouteIdentifier(),this.props.params,this.getNavigationParams({id:t.id})))},getStatusMessage:function(){return"A nice status message ;) "},renderArrowLink:function(e){var t,o,s;switch(t=this.state.otherItems.indexOf(this.state.displayedItem),e){case"left":s=t-1,0>s&&(s=this.state.otherItems.length-1);break;case"right":s=t+1,s>this.state.otherItems.length-1&&(s=0)}return o=this.state.otherItemsIsBackBoneCollection?this.state.otherItems.at(s):this.state.otherItems[s],this.state.otherItemsString&&(this.props.params.only_preview=this.state.otherItemsString),div({className:"col-xs-1 full-height"},r.Link({to:this.getRouteIdentifier(),query:o?this.getNavigationParams({id:o.id}):void 0,params:this.props.params,className:"ef-file-preview-arrow-link"},div({className:"ef-file-preview-arrow"},i({className:"icon-arrow-open-"+e}))))},scrollLeft:function(){var e;return e=$(".ef-file-preview-footer-list").width(),$(".ef-file-preview-footer-list").animate({scrollLeft:"-="+e},300,"easeOutQuad")},scrollRight:function(){var e;return e=$(".ef-file-preview-footer-list").width(),$(".ef-file-preview-footer-list").animate({scrollLeft:"+="+e},300,"easeOutQuad")},closeModal:function(){return this.transitionTo(this.getRouteIdentifier(),this.props.params,this.getNavigationParams({except:"only_preview"}))},render:c(function(){var e,t,o,n;return s({isOpen:!0,onRequestClose:this.closeModal,closeTimeoutMS:10},div({className:"ef-file-preview-overlay"},div({className:"ef-file-preview-container"},div({className:"ef-file-preview-header grid-row middle-xs"},div({className:"col-xs"},div({className:"ef-file-preview-header-filename-container"},h1({className:"ef-file-preview-header-filename"},null!=(e=this.state.initialItem)?e.displayName():void 0))),div({className:"col-xs end-xs"},div({className:"ef-file-preview-header-buttons"},a({className:"ef-file-preview-header-download ef-file-preview-button",href:null!=(t=this.state.displayedItem)?t.get("url"):void 0},i({className:"icon-download"}),l.t("file_preview_headerbutton_download"," Download")),a({className:"ef-file-preview-header-info ef-file-preview-button",href:"#",onClick:this.openInfoPanel},i({className:"icon-info"}),l.t("file_preview_headerbutton_info"," Info")),r.Link({to:this.getRouteIdentifier(),query:this.getNavigationParams({except:"only_preview"}),params:this.props.params,className:"ef-file-preview-header-close ef-file-preview-button"},i({className:"icon-end"}),l.t("file_preview_headerbutton_close"," Close"))))),div({className:"ef-file-preview-preview grid-row middle-xs"},(null!=(o=this.state.otherItems)?o.length:void 0)>0?this.renderArrowLink("left"):void 0,null!=this.state.displayedItem?iframe({src:"/"+v.contextType+"/"+v.contextId+"/files/"+this.state.displayedItem.id+"/file_preview",className:"ef-file-preview-frame"}):void 0,(null!=(n=this.state.otherItems)?n.length:void 0)>0?this.renderArrowLink("right"):void 0,this.state.showInfoPanel?m({displayedItem:this.state.displayedItem,getStatusMessage:this.getStatusMessage}):void 0),div({className:"ef-file-preview-toggle-row grid-row middle-xs"},this.state.showFooterBtn?a({className:"ef-file-preview-toggle col-xs-1 off-xs-1",href:"#",onClick:this.toggleFooter,role:"button",style:this.state.showFooter?{bottom:"21%"}:void 0},this.state.showFooter?l.t("file_preview_hide","Hide"):l.t("file_preview_show","Show")):void 0),this.state.showFooter?u({otherItems:this.state.otherItems,to:this.getRouteIdentifier(),splat:this.props.params.splat,query:this.getNavigationParams,displayedItem:this.state.displayedItem}):void 0)))})})})}).call(this);