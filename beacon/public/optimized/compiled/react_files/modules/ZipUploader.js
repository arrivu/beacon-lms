(function(){var t=function(t,r){return function(){return t.apply(r,arguments)}},r={}.hasOwnProperty,e=function(t,e){function o(){this.constructor=t}for(var n in e)r.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};define(["jquery","./BaseUploader"],function(r,o){var n;return n=function(o){function n(r,e,o,i){this.trackProgress=t(this.trackProgress,this),this.pullMigrationProgress=t(this.pullMigrationProgress,this),this.getContentMigration=t(this.getContentMigration,this),this.onUploadPosted=t(this.onUploadPosted,this),this.onPreflightComplete=t(this.onPreflightComplete,this),n.__super__.constructor.call(this,r,e),this.contextId=o,this.contextType=i,this.migrationProgress=0}return e(n,o),n.prototype.createPreFlightParams=function(){var t;return t={migration_type:"zip_file_importer",settings:{folder_id:this.folder.id},pre_attachment:{name:this.options.name||this.file.name,size:this.file.size,content_type:this.file.type,on_duplicate:this.options.dup||"rename",no_redirect:!0}}},n.prototype.getPreflightUrl=function(){return"/api/v1/"+this.contextType+"/"+this.contextId+"/content_migrations"},n.prototype.onPreflightComplete=function(t){return this.uploadData=t.pre_attachment,this.contentMigrationId=t.id,this._actualUpload()},n.prototype.onUploadPosted=function(t){var e,o,n=this;return t.target&&t.target.status>=400?void this.deferred.reject():(o=this.uploadData.upload_params.success_url,o?r.getJSON(o).then(function(){return n.getContentMigration()}):(e=r.parseJSON(t.target.response),this.getContentMigration()))},n.prototype.getContentMigration=function(){var t=this;return r.getJSON("/api/v1/courses/"+this.contextId+"/content_migrations/"+this.contentMigrationId).then(function(r){return r.progress_url?t.pullMigrationProgress(r.progress_url):setTimeout(function(){return t.getContentMigration()},500)})},n.prototype.pullMigrationProgress=function(t){var e=this;return r.getJSON(t).then(function(r){return e.trackMigrationProgress(r.completion||0),"failed"===r.workflow_state?e.deferred.reject():r.completion<100?setTimeout(function(){return e.pullMigrationProgress(t)},1e3):e.onMigrationComplete()})},n.prototype.onMigrationComplete=function(){var t,r=this;return t=this.folder.files.fetch({reset:!0}).then(function(){return r.deferred.resolve()})},n.prototype.trackProgress=function(t){return this.progress=t.loaded/t.total,this.onProgress(this.progress,this.file)},n.prototype.trackMigrationProgress=function(t){return this.migrationProgress=t/100},n.prototype.getProgress=function(){return(this.progress+this.migrationProgress)/2},n.prototype.roundProgress=function(){var t;return t=this.getProgress()||0,Math.min(Math.round(100*t),100)},n.prototype.getFileName=function(){return this.options.name||this.file.name},n}(o)})}).call(this);